
<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>分組管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .player-tag {
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.15);
      border: 2px solid #60a5fa;
    }
    .group-slot .symbol {
      cursor: pointer;
    }
    .symbol-picker {
      position: absolute;
      display: none;
      z-index: 50;
    }
    .symbol-picker button {
      width: 3.0rem;
      height: 2.5rem;
      margin: 0.25rem;
      font-size: 1.25rem;
      font-family: revert;
      border: 1px solid #ccc;
      border-radius: 0.375rem;
      background-color: #f9fafb;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <h1 class="text-2xl font-bold mb-4 text-center">🏓 分組管理</h1>
  <div class='grid grid-cols-2 gap-6 bg-white p-6 rounded shadow-lg mb-6 relative'>
    <div id="symbol-picker" class="symbol-picker bg-white border rounded shadow p-2 flex flex-wrap w-64 hidden"></div>
<div class='col-span-2 grid grid-cols-2 md:grid-cols-4 gap-4'>
<div id='Day-Beginner'><h2 class='font-semibold text-lg mb-2'>Day-Beginner</h2><div class='flex flex-wrap gap-2'><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Day-Beginner' draggable='true'>華啟梅</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Day-Beginner' draggable='true'>陶家樂</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Day-Beginner' draggable='true'>胡小蓮</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Day-Beginner' draggable='true'>孟愛貞</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Day-Beginner' draggable='true'>林臻</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Day-Beginner' draggable='true'>莊家玲</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Day-Beginner' draggable='true'>施蓉蓉</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Day-Beginner' draggable='true'>蔡鄭翠儀</div></div></div><div id='Day-Advanced'><h2 class='font-semibold text-lg mb-2'>Day-Advanced</h2><div class='flex flex-wrap gap-2'><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Day-Advanced' draggable='true'>羅天文</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Day-Advanced' draggable='true'>Ping Lin</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Day-Advanced' draggable='true'>邱如玉</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Day-Advanced' draggable='true'>謝元興</div></div></div><div id='Night-Beginner'><h2 class='font-semibold text-lg mb-2'>Night-Beginner</h2><div class='flex flex-wrap gap-2'><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Night-Beginner' draggable='true'>林富桂</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Night-Beginner' draggable='true'>徐慶如</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Night-Beginner' draggable='true'>Alexander Nguyen</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Night-Beginner' draggable='true'>Joy Liu</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Night-Beginner' draggable='true'>吳尚真</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Night-Beginner' draggable='true'>李倩</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Night-Beginner' draggable='true'>溫孟璇</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Night-Beginner' draggable='true'>Joseph Richardson</div></div></div><div id='Night-Advanced'><h2 class='font-semibold text-lg mb-2'>Night-Advanced</h2><div class='flex flex-wrap gap-2'><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Night-Advanced' draggable='true'>張立揚</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Night-Advanced' draggable='true'>William Hou</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Night-Advanced' draggable='true'>湯士昀</div><div class='player-tag px-3 py-1 bg-blue-100 text-blue-900 rounded-full cursor-move' data-group='Night-Advanced' draggable='true'>洪國欽</div></div></div></div>
    <div class="bg-slate-50 shadow-inner p-4 rounded border">
      <h2 class="text-lg font-semibold mb-4">Beginner</h2>
      <div class="space-y-3 group-type" id="beginner-groups" data-type="beginner">
    
        <div class="group-slot flex items-center p-2 bg-white border-2 border-gray-300 rounded shadow">
          <button onclick="openSymbolPicker(this)" class="symbol mr-4 w-16 h-10 flex items-center justify-center border border-gray-500 rounded text-xl">?</button>
          <div class="flex flex-wrap gap-2"></div>
          <button onclick="deleteTeam(this.closest('.group-slot'))" class="top-1 right-1 text-red-500">❌</button>
        </div>
        
        <div class="group-slot flex items-center p-2 bg-white border-2 border-gray-300 rounded shadow">
          <button onclick="openSymbolPicker(this)" class="symbol mr-4 w-16 h-10 flex items-center justify-center border border-gray-500 rounded text-xl">?</button>
          <div class="flex flex-wrap gap-2"></div>
          <button onclick="deleteTeam(this.closest('.group-slot'))" class="top-1 right-1 text-red-500">❌</button>
        </div>
        
        <div class="group-slot flex items-center p-2 bg-white border-2 border-gray-300 rounded shadow">
          <button onclick="openSymbolPicker(this)" class="symbol mr-4 w-16 h-10 flex items-center justify-center border border-gray-500 rounded text-xl">?</button>
          <div class="flex flex-wrap gap-2"></div>
          <button onclick="deleteTeam(this.closest('.group-slot'))" class="top-1 right-1 text-red-500">❌</button>
        </div>
        
        <div class="group-slot flex items-center p-2 bg-white border-2 border-gray-300 rounded shadow">
          <button onclick="openSymbolPicker(this)" class="symbol mr-4 w-16 h-10 flex items-center justify-center border border-gray-500 rounded text-xl">?</button>
          <div class="flex flex-wrap gap-2"></div>
          <button onclick="deleteTeam(this.closest('.group-slot'))" class="top-1 right-1 text-red-500">❌</button>
        </div>
        
      </div>
      <button onclick="addGroup('beginner-groups')" class="mt-3 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">新增空間</button>
    </div>
    
    <div class="bg-slate-50 shadow-inner p-4 rounded border">
      <h2 class="text-lg font-semibold mb-4">Advanced</h2>
      <div class="space-y-3 group-type" id="advanced-groups" data-type="advanced">
    
        <div class="group-slot flex items-center p-2 bg-white border-2 border-gray-300 rounded shadow">
          <button onclick="openSymbolPicker(this)" class="symbol mr-4 w-16 h-10 flex items-center justify-center border border-gray-500 rounded text-xl">?</button>
          <div class="flex flex-wrap gap-2"></div>
          <button onclick="deleteTeam(this.closest('.group-slot'))" class="top-1 right-1 text-red-500">❌</button>
        </div>
        
        <div class="group-slot flex items-center p-2 bg-white border-2 border-gray-300 rounded shadow">
          <button onclick="openSymbolPicker(this)" class="symbol mr-4 w-16 h-10 flex items-center justify-center border border-gray-500 rounded text-xl">?</button>
          <div class="flex flex-wrap gap-2"></div>
          <button onclick="deleteTeam(this.closest('.group-slot'))" class="top-1 right-1 text-red-500">❌</button>
        </div>
        
        <div class="group-slot flex items-center p-2 bg-white border-2 border-gray-300 rounded shadow">
          <button onclick="openSymbolPicker(this)" class="symbol mr-4 w-16 h-10 flex items-center justify-center border border-gray-500 rounded text-xl">?</button>
          <div class="flex flex-wrap gap-2"></div>
          <button onclick="deleteTeam(this.closest('.group-slot'))" class="top-1 right-1 text-red-500">❌</button>
        </div>
        
        <div class="group-slot flex items-center p-2 bg-white border-2 border-gray-300 rounded shadow">
          <button onclick="openSymbolPicker(this)" class="symbol mr-4 w-16 h-10 flex items-center justify-center border border-gray-500 rounded text-xl">?</button>
          <div class="flex flex-wrap gap-2"></div>
          <button onclick="deleteTeam(this.closest('.group-slot'))" class="top-1 right-1 text-red-500">❌</button>
        </div>
        
      </div>
      <button onclick="addGroup('advanced-groups')" class="mt-3 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">新增空間</button>
    </div>
    </div>
<div class="mt-6 text-center">
  <button onclick="generateScheduleXMLFromGroups()" class="mt-4 px-4 py-2 bg-green-600 text-white rounded shadow">
  產生賽程 XML
</button>
</div>
<script>
  const suits = ["♠️1", "♠️2", "♠️3", "♠️4", "♥️1", "♥️2", "♥️3", "♥️4", "♥️5", "♥️6", "♥️7", "♥️8"];
  let dragged = null;
  let currentSymbolBtn = null;

  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('.player-tag').forEach(el => {
      el.addEventListener('dragstart', e => dragged = el);
    });
    document.querySelectorAll('.group-slot').forEach(slot => {
      slot.addEventListener('dragover', e => e.preventDefault());
      slot.addEventListener('drop', e => {
        e.preventDefault();
        if (dragged) slot.querySelector('div.flex').appendChild(dragged);
      });
    });

    const picker = document.getElementById("symbol-picker");
    suits.forEach(s => {
      const btn = document.createElement("button");
      btn.textContent = s;
      btn.onclick = () => {
        if (currentSymbolBtn) currentSymbolBtn.textContent = s;
        picker.classList.add('hidden'); picker.classList.remove('flex');
      };
      picker.appendChild(btn);
    });
  });

  function openSymbolPicker(button) {
    currentSymbolBtn = button;
    const picker = document.getElementById("symbol-picker");
    picker.classList.remove('hidden'); picker.classList.add('flex');
    const rect = button.getBoundingClientRect();
    picker.style.top = (window.scrollY + rect.bottom + 4) + 'px';
    picker.style.left = (window.scrollX + rect.left) + 'px';
  }

  function deleteTeam(teamElement) {
    // 1. 把隊伍裡的選手還原
    const players = teamElement.querySelectorAll('.player-tag');
    players.forEach(player => {
      const group = player.getAttribute('data-group');
      const pool = document.getElementById(group);
      if (pool && pool.children.length >= 2) {
        const container = pool.children[1]; // 第二個 child 是選手區
        container.appendChild(player);
      }
    });

    // 2. 從 DOM 中移除整個隊伍元素
    teamElement.remove();
  }

  function addGroup(containerId) {
    const container = document.getElementById(containerId);
    
    const div = document.createElement('div');
    div.className = "group-slot flex items-center p-2 bg-white border-2 border-gray-300 rounded shadow mt-2";
    div.innerHTML = `
      <button onclick="openSymbolPicker(this)" class="symbol mr-4 w-16 h-10 flex items-center justify-center border border-gray-500 rounded text-xl">?</button>
      <div class="flex flex-wrap gap-2" ></div>
      <button onclick="deleteTeam(this.closest('.group-slot'))" class="top-1 right-1 text-red-500">❌</button>
    `;
    container.appendChild(div);

    div.addEventListener('dragover', e => e.preventDefault());
    div.addEventListener('drop', e => {
      e.preventDefault();
      if (dragged) div.querySelector('div.flex').appendChild(dragged);
    });
  }

  function generateXML() {
  let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<groups>\n';
  document.querySelectorAll('.group-slot').forEach(slot => {
    const symbol = slot.querySelector('button.symbol')?.textContent.trim() || '?';
    const players = Array.from(slot.querySelectorAll('.player-tag')).map(p => p.textContent.trim());
    if (players.length > 0) {
      xml += `  <team id="${symbol}">\n`;
      players.forEach(p => {
        xml += `    <player>${p}</player>\n`;
      });
      xml += '  </team>\n';
    }
  });
  xml += '</groups>';
  console.log("📂 分組 XML:");
  console.log(xml);
  alert("✅ XML 已顯示於 console");
}

// 🔽 假設：分組區塊中，每一個 .group-slot 代表一組隊伍
//       每個 .group-slot 裡面有 2 個 .player，並且 data-symbol 屬性代表該隊伍的圖示
// 🔽 假設：分組區塊中，每一個 .group-slot 代表一組隊伍
//       每個 .group-slot 裡面有 2 個 .player，並且 data-symbol 屬性代表該隊伍的圖示

function generateScheduleXMLFromGroups() {
  const beginnerCourts = ['A', 'B'];
  const advancedCourt = 'D';
  const courtMap = { A: [], B: [], D: [] };

  const slots = document.querySelectorAll('.group-slot');
  const beginnerTeams = [];
  const advancedTeams = [];

  slots.forEach(slot => {
    const symbol = slot.querySelector('button.symbol')?.textContent.trim() || '?';
    const players = [...slot.querySelectorAll('.player-tag')].map(p => p.innerText.trim()).filter(x => x);
    const type = slot.closest('.group-type').dataset.type; // beginner / advanced

    const team = {
      symbol,
      players,
    };

    if (type === 'beginner') beginnerTeams.push(team);
    else if (type === 'advanced') advancedTeams.push(team);
  });

  function getMatchups(teams) {
    const result = [];
    const n = teams.length;
    if (n < 4) {
      // 全對全
      for (let i = 0; i < n; i++) {
        for (let j = i + 1; j < n; j++) {
          result.push([teams[i], teams[j]]);
        }
      }
    } else {
      // 每隊與不同對手打3場（簡單隨機挑3個）
      for (let i = 0; i < n; i++) {
        const opponents = [...Array(n).keys()].filter(j => j !== i);
        const selected = opponents.slice(0, 3); // 可加隨機打亂
        selected.forEach(j => {
          if (i < j) result.push([teams[i], teams[j]]);
        });
      }
    }
    return result;
  }

  // 🔄 將 beginnerTeams 分成兩半以對應兩個球場
  const half = Math.ceil(beginnerTeams.length / 2);
  const courtABeginnerTeams = beginnerTeams.slice(0, half);
  const courtBBeginnerTeams = beginnerTeams.slice(half);

  const beginnerMatchesA = getMatchups(courtABeginnerTeams);
  const beginnerMatchesB = getMatchups(courtBBeginnerTeams);
  const advancedMatches = getMatchups(advancedTeams);

  beginnerMatchesA.forEach((pair) => {
    courtMap['A'].push({
      teamL: pair[0],
      teamR: pair[1],
      isBeginner: true,
    });
  });

  beginnerMatchesB.forEach((pair) => {
    courtMap['B'].push({
      teamL: pair[0],
      teamR: pair[1],
      isBeginner: true,
    });
  });

  advancedMatches.forEach(pair => {
    courtMap[advancedCourt].push({
      teamL: pair[0],
      teamR: pair[1],
      isBeginner: false,
    });
  });

  // 🔽 建立 XML 字串
  let xml = `<?xml version="1.0" encoding="UTF-8"?>
<schedule>
<stage name="預賽" active="True">
`;
  Object.entries(courtMap).forEach(([courtId, matches]) => {
    xml += `  <court name="Court ${courtId}">
`;
    matches.forEach(match => {
      const t1 = match.teamL;
      const t2 = match.teamR;
      xml += `    <match 
      teamL="${t1.symbol}" teamR="${t2.symbol}"
      teamLPlayer1="${t1.players[0] || ''}" teamLPlayer2="${t1.players[1] || ''}"
      teamRPlayer1="${t2.players[0] || ''}" teamRPlayer2="${t2.players[1] || ''}"
      court="${courtId}" teamLScore="" teamRScore=""
      isBeginner="${match.isBeginner}" round=""/>
`;
    });
    xml += `  </court>
`;
  });
  xml += '</stage>';
  xml += `<stage name="淘汰賽/冠亞賽" active="False">
<court name="Court A">
<match teamL="" teamR="" teamLPlayer1="" teamLPlayer2="" teamRPlayer1="" teamRPlayer2="" court="A" teamLScore="" teamRScore="" isBeginner="true" round=""/>
</court>
<court name="Court B">
<match teamL="" teamR="" teamLPlayer1="" teamLPlayer2="" teamRPlayer1="" teamRPlayer2="" court="B" teamLScore="" teamRScore="" isBeginner="true" round=""/>
</court>
<court name="Court D">
<match teamL="" teamR="" teamLPlayer1="" teamLPlayer2="" teamRPlayer1="" teamRPlayer2="" court="D" teamLScore="" teamRScore="" isBeginner="false" round=""/>
<match teamL="" teamR="" teamLPlayer1="" teamLPlayer2="" teamRPlayer1="" teamRPlayer2="" court="D" teamLScore="" teamRScore="" isBeginner="false" round=""/>
<match  teamL="" teamR="" teamLPlayer1="" teamLPlayer2="" teamRPlayer1="" teamRPlayer2="" court="D" teamLScore="" teamRScore="" isBeginner="false" round=""/>
</court>
</stage>`;

  xml += `<stage name="冠亞賽" active="False">
<court name="Court A">
<match  teamL="" teamR="" teamLPlayer1="" teamLPlayer2="" teamRPlayer1="" teamRPlayer2="" court="A" teamLScore="" teamRScore="" isBeginner="true" round=""/>
</court>
<court name="Court B"></court>
<court name="Court D">
<match  teamL="" teamR="" teamLPlayer1="" teamLPlayer2="" teamRPlayer1="" teamRPlayer2="" court="D" teamLScore="" teamRScore="" isBeginner="false" round=""/>
<match  teamL="" teamR="" teamLPlayer1="" teamLPlayer2="" teamRPlayer1="" teamRPlayer2="" court="D" teamLScore="" teamRScore="" isBeginner="false" round=""/>
<match  teamL="" teamR="" teamLPlayer1="" teamLPlayer2="" teamRPlayer1="" teamRPlayer2="" court="D" teamLScore="" teamRScore="" isBeginner="false" round=""/>
</court>
</stage>
`;
  
  xml += '</schedule>';

  console.log('📄 賽程 XML:', xml);
  alert('✅ 已產生賽程 XML，可於 console 複製。');
}


</script>
</body>
</html>
